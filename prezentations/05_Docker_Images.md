cypress images
cypress/base
https://hub.docker.com/r/cypress/base
Docker імедж, які містять усі залежності операційної системи, необхідні для запуску Cypress, але НЕ сам Cypress і без попередньо встановлених браузерів.

Якщо потрібна специфічна версія ноди або ОС - то це можна знайти за тегом


cypress/browsers
https://hub.docker.com/r/cypress/browsers
Docker імедж з усіма залежностями операційної системи та деякими попередньо встановленими браузерами, але НЕ сам Cypress.

*Цей імедж використовує користувача root. Можливо, ви захочете перемкнутися на користувача без root під час запуску цього контейнера для безпеки.


cypress/included
https://hub.docker.com/r/cypress/included
Docker імедж із залежностями операційної системи та Cypress, встановленими глобально, і браузерами.

Імеджі позначаються тегами згідно встановленої версії Cypress та версій браузерів; їх має бути достатньо для запуску тестів Cypress в headless режимі або в інтерактивному режимі за допомогою однієї команди Docker, наступна стаття про це.


Запуск локальних Cypress тестів за допомогою докеру

У цьому розділі ми будемо використовувати cypress/included (останньою версією cypress/included є 13.6.0 на момент написання конспекту) і в деяких прикладах і скріншотах версія 12.8.1 . Цей Docker імедж постачається з усіма залежностями операційної системи, встановленним Cypress і браузерами, Chrome, Firefox, Edge, встановленими глобально Існує кілька способів запуску тестів Cypress у контейнерах Docker. Одним із способів є запуск за допомогою наступної команди з кореня вашого проекту:

docker run -it -v $PWD:/e2e -w /e2e cypress/included:13.6.0
За допомогою цієї команди запускаємо усі тести які є нашому проекті у контейнерному середовищі з можливістю монтувати поточний робочий каталог як том, щоб зміни, внесені в хост-систему, відображалися всередині контейнера.

Огляд команди запуску:

docker run - запуск докер контейнеру
-it - параметр вказує, що контейнер повинен працювати в інтерактивному режимі.
-v - для створення простору для зберігання всередині контейнера.
$PWD - монтує поточний робочий каталог (представлений змінною "$PWD")
приклад використання команди pwd


:/e2e - мапає поточну папку на папку /e2e всередині контейнера.
-w /e2e - встановлює робочий каталог всередині контейнера на "/e2e".
cypress/included:13.6.0 визначає Docker імедж для використання в контейнері. У цьому випадку це образ ""cypress/included", який містить Cypress та інші залежності, попередньо встановлені у версії 13.6.0
Щоб забезпечити послідовність і уникнути потенційних проблем, бажано використовувати певний тег імеджу, а не покладатися на тег latest. Це пояснюється тим, що стандартний тег може змінюватися з часом, коли випускаються нові версії імеджу. Якщо ви використовуєте тег latest, ваші тести може випадково використати версію імеджу, відмінну від тієї, яку ви планували, потенційно спричиняючи проблеми сумісності чи інші проблеми.

Використовуючи певний тег зображення, наприклад «cypress/included:12.8.1», ви гарантуєте, що ваша програма завжди використовує ту саму версію зображення. Це може допомогти запобігти неочікуваній поведінці та полегшити вирішення будь-яких проблем, що виникають.

Крім того, використання певного тегу зображення також полегшує відстеження змін і підтримує узгодженість у вашій інфраструктурі. Якщо вам потрібно оновити програму для використання нової версії зображення, ви можете просто оновити тег у своїй конфігурації, а не вручну відстежувати та оновлювати номер версії зображення.

Після запуску команди run докер десктоп автоматично знайде і почне завантаження необхідної версії на локальну машину



Як показано на скріншоті, система намагається знайти Cypress імедж. Спочатку він перевіряє, чи не завантажено у вашу систему. Якщо його не знайдено, система спробує завантажити образ із Docker Hub.


Після успішного завантаження автоматично докер запустить виконання тестів в headless режимі в дефолтному браузері Electron



Можна перевірити запущені контейнери командою

docker ps -a
На скріншоті видно дані контейнера ID, назву, статус



Запуск тестів Cypress на певних версіях браузера може знадобитися для забезпечення сумісності кросбраузерності. По дефолту Cypress запускає тести у браузері Electron, але якщо ви хочете запустити тести Cypress у браузерах Chrome і Firefox за допомогою образу Docker, виконайте наведені нижче потрібно передати параметр —browser для команди

docker run -it -v $PWD:/e2e -w /e2e cypress/included:12.8.1 --browser firefox
docker run -it -v $PWD:/e2e -w /e2e cypress/included:12.8.1 --browser chrome
Результат виконання тестів в докері такий самий як і запуск локально

playwright images
Докер імеджі для playwright знаходяться в реджістрі microsoft artifact registry


Playwright Microsoft
https://mcr.microsoft.com/en-us/product/playwright/about
По дефолту Docker імедж використовуватиме користувача root для запуску браузерів. Це вимкне Chromium sandbox, яка недоступна з root. Якщо ви запускаєте перевірений код (наприклад, е2е тести) і хочете уникнути клопоту з керуванням окремим користувачем, то можна і користувача root використовувати.

docker run -it --rm --ipc=host mcr.microsoft.com/playwright:v1.40.0-jammy /bin/bash
❗Під час використання Chrome браузера рекомендується використовувати параметр --ipc=host. Без цього параметра в Chrome може закінчитися пам’ять.

❗якщо є потреба в запуску тестів на різних версіях ОС то потрібно змінювати тег для докер імеджу

Ubuntu 22.04 LTS (Jammy Jellyfish), image tags include jammy
Ubuntu 20.04 LTS (Focal Fossa), image tags include focal
Також потрібно звертати увагу на локальну версію і на версію яка буде в докер імеджі - потрібно використовувати таку ж версію яка локально.

Під час запуску в контейнері є можливість передати усі параметри по запуску тестів які доступні для playwright


Command line
https://playwright.dev/docs/test-cli
Запуск локальних Playwright тестів за допомогою докеру

Для завантаження тестів які є локально можна використовувати таку ж команду як для Cypress тестів
docker run -v $PWD:/e2e -w /e2e — rm -it mcr.microsoft.com/playwright:v1.40.0-focal
it - працювати в інтерактивному режимі.
v - для створення простору для зберігання всередині контейнера.
w - встановлює робочий каталог всередині контейнера на "/e2e".
ipc=host - параметр для запуску різних браузерів

Підсумки
На цій лекції розглянули основні підходи для пришвидшення релізів і отримання фібдеку по коду, впровадження автоматизованого тестування в пайплайни. Розглняули основні прнинципи технології докер. Налаштування і запуск тестів всередині докер контейнерів.
