# Tilt у роботі автоматизатора: від хаосу до порядку в локальній розробці

*Навчальний матеріал для початківців у автоматизаційному тестуванні*

---

## Для кого і коли

Цей матеріал стосується **локальної** розробки та тестування, коли ви одночасно підтримуєте кілька сервісів або контейнерів (наприклад, застосунок + база + тести). Якщо ви тільки починаєте з Docker і CI/CD, достатньо спочатку освоїти запуск тестів у контейнері (див. попередні розділи). До Tilt має сенс повертатися, коли з'явиться потреба в автоматичному перезапуску та синхронізації кількох компонентів при зміні коду.

Уявіть ситуацію: ви написали автоматизований тест, запустили його — і отримали помилку. Перезапустили Docker, очистили кеш, перезавантажили сервіс, знову запустили тест. Ще помилка. Ви витратили годину не на написання тестів, а на підтримку локального середовища в робочому стані. Саме для вирішення цієї проблеми і було створено **Tilt** — інструмент, який автоматизує саму автоматизацію.

---

## Що таке Tilt і чому він важливий

[Tilt](https://tilt.dev) — це інструмент для автоматизації локального середовища розробки, який особливо корисний при роботі з мікросервісами та контейнеризованими застосунками. Простіше: Tilt стежить за вашим кодом і автоматично перебудовує, перезапускає та оновлює потрібні сервіси щоразу, коли ви вносите зміни.

Для автоматизатора Tilt вирішує конкретну проблему: підтримку локального середовища, яке необхідне для запуску тестів. Замість того щоб вручну перезапускати сервіси, оновлювати образи Docker і відстежувати стан залежностей, Tilt робить усе це автоматично у фоновому режимі.

### Основні можливості Tilt

- Автоматичне відстеження змін у файлах та реакція на них
- Перебудова Docker-образів лише тоді, коли це дійсно потрібно
- Зручний веб-інтерфейс для моніторингу стану всіх сервісів у режимі реального часу
- Підтримка Kubernetes та Docker Compose
- Налаштування через конфігураційний файл **Tiltfile** — один файл у корені проекту, де описується, які образи збирати, які сервіси запускати і за якими файлами слідкувати. Він пишеться мовою **Starlark** (синтаксис схожий на Python; достатньо базових конструкцій)

---

## Де використовується Tilt в автоматизаційному тестуванні

### Сценарій 1. Інтеграційне тестування мікросервісів

Припустімо, ваш проект складається з трьох сервісів: Auth Service, Product Service та Order Service. Ваші тести перевіряють, як вони взаємодіють між собою. Без Tilt вам потрібно вручну стежити, щоб усі три сервіси були запущені та оновлені перед запуском тестів. З Tilt — ви відкриваєте один термінал, запускаєте `tilt up`, і Tilt сам подбає про запуск і синхронізацію всього середовища.

### Сценарій 2. Швидкий цикл розробки тестів

Під час написання тестів ви постійно вносите дрібні зміни та хочете бачити результат негайно. Tilt може бути налаштований так, щоб автоматично запускати відповідні тести при збереженні файлів. Цикл «зміна коду → перезапуск → результат» скорочується з кількох хвилин до кількох секунд.

### Сценарій 3. Тестування в контейнеризованому середовищі

Коли ваші тести мають запускатися в Docker-контейнері (щоб відтворити продакшн-середовище), кожна зміна в тестовому коді потребує перебудови образу. Tilt оптимізує цей процес за допомогою **live update** — механізм, коли змінені файли (наприклад, тести) синхронізуються у вже запущений контейнер без повної перебудови образу, що значно прискорює цикл «змінив код — побачив результат».

---

## Переваги над традиційними підходами

### Без Tilt (традиційний підхід)

1. Вносите зміни до коду тесту або застосунку
2. Вручну зупиняєте запущені контейнери: `docker-compose down`
3. Перебудовуєте образ: `docker-compose build`
4. Запускаєте середовище знову: `docker-compose up`
5. Чекаєте, поки всі сервіси піднімуться та будуть готові
6. Запускаєте тести і **повторюєте весь цикл** при кожній зміні

### З Tilt

1. Одноразово запускаєте `tilt up`
2. Вносите зміни до коду
3. Tilt автоматично оновлює лише те, що потребує оновлення — решта залишається незмінною

**Головна перевага — економія часу.** За даними команди Tilt, розробники економлять від 15 до 60 хвилин щоденно лише на усуненні проблем із локальним середовищем. Для автоматизатора, який активно пише та відлагоджує тести, це означає суттєво вищу продуктивність.

---

## Початок роботи з Tilt

### Крок 1. Встановлення

**macOS (через Homebrew):**
```bash
brew install tilt
```

**Linux або macOS (через curl):**
```bash
curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
```

**Windows (через scoop):**
```bash
scoop install tilt
```

Після встановлення перевірте: `tilt version`

### Крок 2. Вимоги та передумови

- **Docker Desktop** або **Docker Engine** — основа для запуску контейнерів
- **kubectl** (опціонально) — якщо плануєте використовувати Tilt з Kubernetes

### Крок 3. Перший Tiltfile

`Tiltfile` — серце конфігурації Tilt. Він описує, що потрібно запустити, як це зробити і за якими файлами стежити. Створіть файл з назвою `Tiltfile` (без розширення) у кореневій директорії проекту.

Основні конструкції:

- **`docker_build()`** — як зібрати Docker-образ і де знаходиться Dockerfile. Параметр `live_update` дозволяє синхронізувати файли прямо в контейнер без повної перебудови образу.
- **`docker_compose()`** — підключає існуючий `docker-compose.yml`. Tilt візьме всі описані в ньому сервіси під своє управління.
- **`local_resource()`** — локальна команда (наприклад, запуск тестів), яку Tilt запускатиме автоматично. Параметр `deps` вказує, при зміні яких файлів перезапускати команду; `resource_deps` — після якого ресурсу (наприклад, api-server) її виконувати.

### Крок 4. Запуск і веб-інтерфейс

Запустіть Tilt у директорії з Tiltfile:
```bash
tilt up
```

Tilt відкриє веб-інтерфейс за адресою **http://localhost:10350**. У ньому: всі сервіси та ресурси, їхній поточний стан (запущено / будується / помилка), логи кожного сервісу в реальному часі та час останнього оновлення. Це зручніше, ніж переглядати кілька терміналів одночасно.

---

## Типові виклики та способи їх вирішення

### Виклик 1. Тести запускаються до готовності сервісу

**Проблема:** Tilt запускає тести відразу після старту, але API-сервер ще не встиг повністю завантажитися. Тести падають з помилкою підключення.

**Рішення:** використовуйте параметр `resource_deps`, щоб вказати залежність від іншого ресурсу (наприклад, `resource_deps=['api-service']`), щоб тести запускалися тільки після старту api-service.

### Виклик 2. Повільна перебудова образів

**Проблема:** при кожній дрібній зміні Tilt повністю перебудовує Docker-образ, що займає кілька хвилин.

**Рішення:** використовуйте `live_update` для синхронізації файлів напряму в контейнер. Tilt оновлює лише змінені файли, не перезбираючи весь образ. Повна перебудова відбувається тільки тоді, коли змінюється Dockerfile або системні залежності.

### Виклик 3. Занадто часті запуски тестів

**Проблема:** ви активно пишете код, і Tilt запускає тести після кожного збереження файлу.

**Рішення:** у веб-інтерфейсі можна вимкнути автоматичний запуск конкретного ресурсу і запускати тести вручну. Або в Tiltfile: `trigger_mode=TRIGGER_MODE_MANUAL` для `local_resource`.

---

## Коли Tilt не є найкращим вибором

Tilt буде зайвим, якщо:

- ви тестуєте простий скрипт без будь-яких зовнішніх залежностей
- ваш проект не використовує Docker або Kubernetes
- вся тестова інфраструктура запускається однією командою і ніколи не потребує перезапуску

**Tilt найбільш цінний тоді,** коли тестове середовище складається з кількох контейнеризованих компонентів, які потрібно підтримувати в синхронізованому стані під час активної розробки.

---

## Висновок

Tilt вирішує реальну проблему автоматизаторів: підтримку локального середовища в актуальному стані під час активної розробки тестів. Замість того щоб витрачати час на ручні перезапуски сервісів, ви фокусуєтеся на написанні якісних тестів, поки Tilt бере на себе рутину.

Для початку достатньо трьох кроків: встановити Tilt, написати мінімальний `Tiltfile` для свого проекту та запустити `tilt up`. Веб-інтерфейс покаже все необхідне.

**Практичне завдання для самоперевірки:** встановіть Tilt, створіть тестовий проект з будь-яким веб-сервером (Flask або Express) та напишіть один простий тест, який перевіряє, що сервер відповідає на GET-запит. Налаштуйте `Tiltfile` так, щоб тест автоматично запускався при зміні файлів сервера або тестів. Порівняйте час циклу «зміна → перевірка результату» з традиційним підходом та з Tilt.

Офіційна документація: [docs.tilt.dev](https://docs.tilt.dev)

---

## Приклади у цій папці

У підпапці [examples](./examples/) — мінімальний приклад Tiltfile для проекту з API та автотестами: `docker_build` з live update, `local_resource` для тестів з `resource_deps`.

Повний текст лекції: [prezentations/06_tilt_local_k8.md](../../prezentations/06_tilt_local_k8.md).
