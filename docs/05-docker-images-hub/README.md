# Docker-образи для тестування: Cypress та Playwright

## Навіщо запускати тести в Docker

Автотести (Cypress, Playwright) потребують певного середовища: версія Node.js, браузери, системні бібліотеки. На різних машинах і в CI це середовище може відрізнятися, через що виникають помилки типу «у мене працює, на CI — ні». Готові **Docker-образи** для Cypress і Playwright містять уже налаштоване середовище, тому тести можна запускати однаково локально і в пайплайні.

У цьому розділі — коротко про образи Cypress і Playwright та як запускати в них тести.

---

## Образи Cypress (Docker Hub)

Офіційні образи публікуються на [Docker Hub](https://hub.docker.com/u/cypress). Є три основні варіанти:

### cypress/base

- [cypress/base на Docker Hub](https://hub.docker.com/r/cypress/base)
- Містить залежності ОС, необхідні для запуску Cypress, але **без** встановленого Cypress і без попередньо встановлених браузерів.
- Підходить, коли ви самі встановлюєте Cypress у своєму Dockerfile і контролюєте версію Node та ОС. Теги відображають версію Node або ОС (наприклад, `cypress/base:18`).

### cypress/browsers

- [cypress/browsers на Docker Hub](https://hub.docker.com/r/cypress/browsers)
- ОС + частина браузерів вже встановлена, але **без** самого Cypress.
- Зручно для кастомних збірок, де ви встановлюєте Cypress у Dockerfile.
- **Примітка:** образ за замовчуванням може працювати під користувачем root; для безпеки в продакшені часто створюють не-root користувача в Dockerfile.

### cypress/included (найзручніший для швидкого старту)

- [cypress/included на Docker Hub](https://hub.docker.com/r/cypress/included)
- ОС + Cypress + браузери вже встановлені. Достатньо змонтувати проект з тестами і запустити Cypress однією командою.
- Теги відповідають версії Cypress (наприклад, `cypress/included:13.6.0`). Цього достатньо для запуску тестів у **headless** або інтерактивному режимі.

**Headless** — режим без видимого вікна браузера; тести виконуються у фоновому режимі.

---

## Запуск локальних Cypress-тестів у Docker

Нижче використовується образ **cypress/included** (на прикладі версії 13.6.0; логіка та сама для інших версій).

### Базова команда

З кореня проекту (де лежать тести):

```bash
docker run -it -v $PWD:/e2e -w /e2e cypress/included:13.6.0
```

**Що робить команда:**

- **docker run** — створити і запустити контейнер з указаного образу.
- **-it** — інтерактивний режим з терміналом (корисно для перегляду виводу і інтерактивного Cypress).
- **-v $PWD:/e2e** — змонтувати поточну директорію хоста (`$PWD`) в контейнер як `/e2e`. Файли на хості і в контейнері синхронізовані: зміни в тестах на хості одразу видно в контейнері.
- **-w /e2e** — робоча директорія всередині контейнера `/e2e` (тут будуть ваші тести).
- **cypress/included:13.6.0** — образ і тег версії.

Після запуску Docker за потреби завантажить образ з Docker Hub, потім у контейнері запуститься Cypress (за замовчуванням у headless у браузері Electron). Результати виконання такі ж, як при локальному запуску Cypress на машині.

### Чому краще фіксувати тег версії

Краще явно вказувати тег (наприклад, `13.6.0`), а не `latest`:

- **latest** змінюється при виході нових версій; тести можуть несподівано перейти на іншу версію Cypress і почати поводитися інакше.
- Фіксований тег дає відтворюваність: однакове середовище на всіх машинах і в CI.
- Оновлення — свідома зміна тегу в команді або в CI-конфігурації.

### Запуск у конкретному браузері

За замовчуванням Cypress у контейнері використовує Electron. Для перевірки в Chrome або Firefox передайте `--browser`:

```bash
docker run -it -v $PWD:/e2e -w /e2e cypress/included:12.8.1 --browser firefox
docker run -it -v $PWD:/e2e -w /e2e cypress/included:12.8.1 --browser chrome
```

Це корисно для кросбраузерного тестування.

---

## Образи Playwright (Microsoft Container Registry)

Офіційні образи Playwright публікуються в **Microsoft Container Registry (MCR)**, а не на Docker Hub.

- [Playwright на MCR](https://mcr.microsoft.com/en-us/product/playwright/about)

У образах вже є потрібні залежності ОС та браузери; можна запускати тести так само, як локально, передаючи потрібні параметри CLI.

### Користувач root і sandbox

За замовчуванням контейнер виконується від імені **root**. У такому режимі Chromium sandbox часто вимкнено (він недоступний під root). Для перевіреного коду (наприклад, e2e-тестів) у навчальних і тестових середовищах це часто прийнятно; для продакшену можна налаштувати не-root користувача в Dockerfile.

### Параметр --ipc=host для Chrome

При використанні Chrome у контейнері **рекомендується** додавати `--ipc=host`, інакше Chrome може зіткнутися з проблемами пам'яті (out of memory тощо).

Приклад інтерактивної оболонки в контейнері:

```bash
docker run -it --rm --ipc=host mcr.microsoft.com/playwright:v1.40.0-jammy /bin/bash
```

- **--rm** — видалити контейнер після виходу.
- **--ipc=host** — використовувати простір імен IPC хоста (потрібно для стабільності Chrome).
- **jammy** — образ на базі Ubuntu 22.04 LTS. Для Ubuntu 20.04 використовують теги з **focal**.

### Версії ОС у тегах

- **jammy** — Ubuntu 22.04 LTS  
- **focal** — Ubuntu 20.04 LTS  

Якщо потрібно тестувати на різних версіях ОС, варто вибирати відповідний тег образу. Також краще узгоджувати версію Playwright у контейнері з версією у вашому проєкті (package.json), щоб уникнути розбіжностей у поведінці.

Усі параметри запуску тестів (фільтри, workers, retries тощо) можна передавати в контейнер так само, як при локальному запуску. Деталі: [Playwright Test CLI](https://playwright.dev/docs/test-cli).

---

## Запуск локальних Playwright-тестів у Docker

Ідея та сама, що в Cypress: монтуємо поточну директорію в контейнер і задаємо робочу директорію.

Приклад:

```bash
docker run -v $PWD:/e2e -w /e2e --rm -it --ipc=host mcr.microsoft.com/playwright:v1.40.0-focal
```

- **-v $PWD:/e2e** — монтування поточної папки в `/e2e` у контейнері.
- **-w /e2e** — робоча директорія `/e2e`.
- **--rm** — видалити контейнер після завершення.
- **-it** — інтерактивний режим.
- **--ipc=host** — рекомендується при використанні Chrome.

Далі всередині контейнера можна виконувати звичайні команди Playwright (наприклад, `npx playwright test`), або передати їх у `docker run` як команду замість стандартної оболонки.

**Примітка:** `--ipc=host` потрібен для стабільної роботи **Chrome** у контейнері (зменшення ризику збоїв через пам'ять), а не для «запуску різних браузерів».

---

## Підсумки

- **Cypress:** для швидкого запуску тестів у контейнері зручно використовувати **cypress/included** з фіксованим тегом версії; для кастомних збірок — **cypress/base** або **cypress/browsers**.
- **Playwright:** образи беруть з Microsoft Container Registry (MCR); для Chrome варто використовувати **--ipc=host**; теги (jammy/focal) визначають версію Ubuntu.
- В обох випадках тести з хоста підключаються через **-v $PWD:/e2e** і **-w /e2e**, результат виконання такий самий, як при локальному запуску.
- Фіксування версії образу (тегу) забезпечує однакове середовище локально та в CI і полегшує відтворення проблем.

---

## Приклади у цій папці

У підпапці [examples](./examples/) — готові команди та скрипт `run-playwright-in-docker.sh` для запуску Playwright-тестів у Docker з монтуванням папки та `--ipc=host`.

Повний текст лекції: [prezentations/05_Docker_Images.md](../../prezentations/05_Docker_Images.md).
